{% extends "base.html" %}

{% block title %}Shopify Store Scraper API - Home{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="text-center mb-5">
            <h1 class="display-4 mb-3">
                <i data-feather="search" class="me-3"></i>
                Shopify Store Scraper API
            </h1>
            <p class="lead">Extract comprehensive insights from any Shopify store including products, policies, and brand information.</p>
        </div>

        <!-- API Testing Interface -->
        <div class="card mb-5">
            <div class="card-header">
                <h3 class="card-title mb-0">
                    <i data-feather="terminal" class="me-2"></i>
                    Test API Endpoint
                </h3>
            </div>
            <div class="card-body">
                <form id="scraperForm">
                    <div class="mb-3">
                        <label for="websiteUrl" class="form-label">Shopify Store URL</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i data-feather="globe"></i>
                            </span>
                            <input type="url" class="form-control" id="websiteUrl" 
                                   placeholder="https://example.myshopify.com or https://example.com" 
                                   required>
                        </div>
                        <div class="form-text">
                            Enter any Shopify store URL. Examples: memy.co.in, hairoriginals.com
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="scrapeBtn">
                        <i data-feather="download" class="me-2"></i>
                        Fetch Store Insights
                    </button>
                </form>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="text-center mb-4" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Scraping store data... This may take a few moments.</p>
        </div>

        <!-- Results -->
        <div id="results" style="display: none;">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i data-feather="database" class="me-2"></i>
                        Store Insights
                    </h4>
                    <button class="btn btn-secondary btn-sm" onclick="copyToClipboard()">
                        <i data-feather="copy" class="me-1"></i>
                        Copy JSON
                    </button>
                </div>
                <div class="card-body">
                    <div id="resultsSummary" class="mb-3"></div>
                    <pre id="resultsJson" class="bg-dark p-3 rounded" style="max-height: 500px; overflow-y: auto;"></pre>
                </div>
            </div>
        </div>

        <!-- Error Display -->
        <div id="errorAlert" class="alert alert-danger" style="display: none;">
            <i data-feather="alert-circle" class="me-2"></i>
            <span id="errorMessage"></span>
        </div>
    </div>
</div>

<!-- API Documentation -->
<div class="row mt-5">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title mb-0">
                    <i data-feather="book" class="me-2"></i>
                    API Documentation
                </h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>Endpoint</h5>
                        <code>POST /fetch_insights</code>
                        
                        <h5 class="mt-4">Request Body</h5>
                        <pre class="bg-dark p-3 rounded">
{
  "website_url": "https://example.myshopify.com"
}
                        </pre>
                    </div>
                    <div class="col-md-6">
                        <h5>Response Data Includes</h5>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item"><i data-feather="package" class="me-2"></i>Complete Product Catalog</li>
                            <li class="list-group-item"><i data-feather="star" class="me-2"></i>Hero/Featured Products</li>
                            <li class="list-group-item"><i data-feather="shield" class="me-2"></i>Privacy Policy</li>
                            <li class="list-group-item"><i data-feather="rotate-ccw" class="me-2"></i>Return & Refund Policies</li>
                            <li class="list-group-item"><i data-feather="help-circle" class="me-2"></i>Brand FAQs</li>
                            <li class="list-group-item"><i data-feather="users" class="me-2"></i>Social Media Handles</li>
                            <li class="list-group-item"><i data-feather="phone" class="me-2"></i>Contact Details</li>
                            <li class="list-group-item"><i data-feather="info" class="me-2"></i>Brand Context (About)</li>
                            <li class="list-group-item"><i data-feather="link" class="me-2"></i>Important Links</li>
                        </ul>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h5>HTTP Status Codes</h5>
                    <div class="row">
                        <div class="col-md-4">
                            <span class="badge bg-success">200</span> Success - Data retrieved
                        </div>
                        <div class="col-md-4">
                            <span class="badge bg-warning">401</span> Website not found/accessible
                        </div>
                        <div class="col-md-4">
                            <span class="badge bg-danger">500</span> Internal server error
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('scraperForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const websiteUrl = document.getElementById('websiteUrl').value;
    const scrapeBtn = document.getElementById('scrapeBtn');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const results = document.getElementById('results');
    const errorAlert = document.getElementById('errorAlert');
    
    // Reset UI
    results.style.display = 'none';
    errorAlert.style.display = 'none';
    loadingIndicator.style.display = 'block';
    scrapeBtn.disabled = true;
    scrapeBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Scraping...';
    
    try {
        const response = await fetch('/fetch_insights', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ website_url: websiteUrl })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // Success - display results
            displayResults(data);
            results.style.display = 'block';
        } else {
            // Error response
            showError(data.message || 'An error occurred while fetching store insights');
        }
        
    } catch (error) {
        showError('Network error: Unable to connect to the API');
        console.error('Error:', error);
    } finally {
        // Reset UI
        loadingIndicator.style.display = 'none';
        scrapeBtn.disabled = false;
        scrapeBtn.innerHTML = '<i data-feather="download" class="me-2"></i>Fetch Store Insights';
        feather.replace();
    }
});

function displayResults(data) {
    // Create summary
    const summary = createSummary(data);
    document.getElementById('resultsSummary').innerHTML = summary;
    
    // Display JSON
    document.getElementById('resultsJson').textContent = JSON.stringify(data, null, 2);
}

function createSummary(data) {
    const stats = [
        { label: 'Products', count: data.products?.length || 0, icon: 'package' },
        { label: 'Hero Products', count: data.hero_products?.length || 0, icon: 'star' },
        { label: 'FAQs', count: data.faqs?.length || 0, icon: 'help-circle' },
        { label: 'Social Handles', count: Object.keys(data.social_handles || {}).length, icon: 'users' },
        { label: 'Important Links', count: data.important_links?.length || 0, icon: 'link' }
    ];
    
    let html = `
        <div class="mb-3">
            <h5><i data-feather="info" class="me-2"></i>${data.store_name || 'Unknown Store'}</h5>
            <p class="text-muted mb-2">${data.website_url}</p>
        </div>
        <div class="row">
    `;
    
    stats.forEach(stat => {
        html += `
            <div class="col-md-2 col-sm-4 col-6 mb-2">
                <div class="text-center">
                    <i data-feather="${stat.icon}" class="mb-1"></i>
                    <div class="fw-bold">${stat.count}</div>
                    <small class="text-muted">${stat.label}</small>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    // Add policy status
    const policies = [
        { label: 'Privacy Policy', has: !!data.privacy_policy },
        { label: 'Return Policy', has: !!data.return_policy },
        { label: 'Brand Context', has: !!data.brand_context }
    ];
    
    html += '<div class="mt-3"><h6>Policies & Content:</h6><div class="row">';
    policies.forEach(policy => {
        const badgeClass = policy.has ? 'bg-success' : 'bg-secondary';
        const icon = policy.has ? 'check' : 'x';
        html += `
            <div class="col-md-4 col-sm-6 mb-1">
                <span class="badge ${badgeClass}">
                    <i data-feather="${icon}" style="width: 12px; height: 12px;"></i>
                    ${policy.label}
                </span>
            </div>
        `;
    });
    html += '</div></div>';
    
    return html;
}

function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorAlert').style.display = 'block';
}

function copyToClipboard() {
    const jsonText = document.getElementById('resultsJson').textContent;
    navigator.clipboard.writeText(jsonText).then(function() {
        // Show temporary success message
        const copyBtn = event.target.closest('button');
        const originalText = copyBtn.innerHTML;
        copyBtn.innerHTML = '<i data-feather="check" class="me-1"></i>Copied!';
        copyBtn.classList.remove('btn-secondary');
        copyBtn.classList.add('btn-success');
        
        setTimeout(() => {
            copyBtn.innerHTML = originalText;
            copyBtn.classList.remove('btn-success');
            copyBtn.classList.add('btn-secondary');
            feather.replace();
        }, 2000);
        
        feather.replace();
    });
}

// Initialize icons on page load
document.addEventListener('DOMContentLoaded', function() {
    feather.replace();
});
</script>
{% endblock %}
